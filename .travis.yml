os: linux
dist: bionic
language: php

before_install:
  - composer global require "fxp/composer-asset-plugin:~1.4.6"
  - openssl aes-256-cbc -K $encrypted_<...>_key -iv $encrypted_<...>_iv -in travis-openssh-pk.enc -out /tmp/deploy_rsa -d
  - eval "$(ssh-agent -s)"
  - chmod 600 /tmp/deploy_rsa
  - ssh-add /tmp/deploy_rsa
  - ssh -o StrictHostKeyChecking=no -l "$SSH_USER" "$SSH_HOST"

addons:
  apt:
    update: true

script:
  - echo "Building"
  - composer install --no-dev --ignore-platform-reqs -o -q
  - npm i
  - npm run build
  - rm -rf node_modules
  - npm i --production

deploy:
  - provider: script
    skip_cleanup: true
    script: bash scripts/deploy.sh
    on:
      branch: master